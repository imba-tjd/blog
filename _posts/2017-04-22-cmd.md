---
title: cmd命令
---

## 语法

* 不支持数组
* 通配符不由shell展开，而是普通的字符，由命令自行处理
* 支持`.`表示当前目录，但作为执行目标时不支持
* 快捷键：F3按已输入内容和历史补全命令，F7历史命令，F11全屏，PauseBreak临时暂停按回车继续，Alt+PrintScreen截屏
* 转义：在双引号外时，用^加`& < > ( ) @ ^ |`能表示对应的字面量而非特殊字符。双引号内两个%转义出一个
* 切换磁盘路径时，直接用`d:`就可以换盘符，且能换到上次离开的位置（如果有）
* 待执行命令若用完整路径不支持斜杠

## 变量

* 声明：set a=10，等号两边都一定不能有空格，也不要有引号，否则会算作变量名和值的一部分。另一种选择是set "a=12&34"，允许有特殊符号，但值好像又不方便有引号字面量
* 使用：cli %a%，如果值中有空格可用cli "%a%"。值中有引号难以处理
* 当变量不存在时，不会报错，而是作为字面量`%a%`
* 变量名大小写不敏感
* SETLOCAL：无参使用用于隔离变量作用域，内层在未被赋值时仍能读取上层的，用ENDLOCAL结束。仅在bat中有效

## 命令行参数

* 运行bat和使用call命令时可以传参
* %1 %2 ... %9
* %*：所有参数

### 参数扩展

* %~f1：绝对路径
* %~dp1：一般意义上的父文件夹路径带尾反斜杠。d为盘符如`C:`，p为仅全部路径如`\utils\`
* %~nx1：基本名加后缀。n为基本名无后缀，x为后缀带点
* %~1：移除值中包裹的引号 TODO:测试
* %~$PATH:1：搜索PATH环境变量并把%1扩展为第一个匹配的

## 环境变量

* 这些路径都不带尾反斜杠且不带引号
* CD：当前路径
* RANDOM：目测是0-32768
* TIME：格式与无参time命令相同`11:29:21.12`
* AppData、LocalAppData：略
* WinDir：与SystemRoot相同，默认C:\Windows
* ProgramFiles（根据CMD进程位数不同而不同）、ProgramFiles(x86)、ProgramW6432（64位系统上永远等于64位的PF与CMD位数无关）
* PATHEXT：决定哪些文件不用输后缀也能打开

## 内置命令

* assoc：无参调用显示所有关联但难以人类阅读。一般用`~ .exe=exefile`修复关联，=空能删除关联
* cd或chdir：切换磁盘时要用/d，否则只会显示对应位置的内容；不把空格视为分隔符，cd a b与cd "a b"一样；支持通配符
* cls：清屏
* date：/T显示`2022/02/14 周一`，也可以用来修改日期
* dir：支持通配符，/s递归，/b一行一个不显示额外信息，/a:d仅显示目录，还支持按日期或大小排序
* echo：echo "123"会输出`"123"`，真的反人类。`echo.`无空格输出一空行
* exit：可指定exitcode，/b指定退出当前批处理脚本而非cmd
* prompt：更改提示符，默认$P$G，可以考虑加个$T时间
* time：/T显示时分，也可以用来修改时间
* type：显示文本文件内容
* ver：显示Win的版本，也是cmd启动时输出的内容
* vol：显示卷标
* where：在CWD和PATH中搜索文件，不支持搜索文件夹，支持通配符，可一次指定多个模式；/R递归搜索指定目录
* rem：注释

## 外置命令

* arp：/a显示所有接口和与其同网段的ip和MAC
* attrib：给文件设置属性，+设置-取消 r只读s系统h隐藏 /s递归处理
* bitsadmin
  * 作为下载器，支持创建任务批量下载和暂停取消：/transfer 任务名 网址 保存文件名
  * 获取和修改自动代理设置：/util /getieproxy LOCALSYSTEM、/util /setIEproxy LOCALSYSTEM NO_PROXY或AUTOSCRIPT PAC网址或MANUAL_PROXY proxy1,proxy2 绕过列表或NULL
* cacls：已弃用。使用icacls
* chkdsk
  * 仅扫描：/scan /perf
  * 仅修复已知的问题，只需一秒：/spotfix
  * /b隐含/r
* clip：把stdin的内容复制到剪切板上
* convert：把FAT转换成NTFS
* hostname：显示本机主机名
* msiexec：/i 安装，/x 卸载，/passive 自动无交互但有进度条，/quiet 无交互
* powercfg：/h on/off启用或关闭休眠，/a显示系统支持的睡眠级别
* print：真实的打印文本文件
* rstrui：系统还原对话框
* sc：配置服务
* systeminfo：显示内存大小、网卡信息、系统安装日期
* whoami：无参使用显示`主机名\用户名`，用/ALL可显示所有用户及SID、组信息、特权信息
* wmic：已弃用

## bat转exe

* https://www.battoexeconverter.com/ 界面很老
* https://github.com/islamadel/bat2exe/ 本身就是bat写的
* https://bat-to-exe-converter-x64.en.softonic.com/ 程序感觉最好，官网在 http://www.f2ko.de/en/b2e.php 但是已经挂了，最后更新2019年
* https://bc.gotek.info/ 收费不过有免费版
* https://www.softpedia.com/get/Programming/Other-Programming-Files/Slimm-Bat-to-Exe.shtml 最后更新2015年
* iexpress：系统自带

## 其它

* 开始时自动运行命令：`[HKEY_LOCAL_MACHINE\Software\Microsoft\Command Processor] "AutoRun"=-`
* 32位进程访问64位系统命令：C:\Windows\sysNative\，如果用system32会自动重定向到syswow64
* SYSTEM权限：https://zhuanlan.zhihu.com/p/31897805
* 在win+r中运行`\`可在explorer中打开c盘

集合
----

* https://docs.microsoft.com/zh-cn/windows-server/administration/windows-commands/call
* https://ss64.com/nt/syntax.html 看完了Services Env Array，args看到和for交互的地方了
* https://www.jb51.net/help/cmd.htm
* https://www.jb51.net/article/7131.htm
* https://www.zhihu.com/question/34941855
* https://blog.51cto.com/wanderboy/1684180
* http://www.bathome.net/ 批处理之家
* https://www.programming-books.io/essential/batch/

我记录的
--------

* fsutil：file SetCaseSensitiveInfo 文件夹名称 enable启用大小写区分
* icacls /reset；cacls被deprecated了，icacls可以控制权限，takeown可以更改所有者
* cipher
* mklink：此命令是cmd内建的
* mbr2gpt /convert /allowfullos
* netstat -anop TCP；a显示listen的，n避免持续输出，o显示对应的PID，p指定协议
* route print
* cmd /c *实际命令*：使用cmd运行完这个命令以后就退出
* dir /b /s：递归输出所有文件，一行一个
* setx /m path "%path%;C:\WebDriver\bin\" ：永久修改环境变量
* certutil -hashfile D:\1.exe MD5
* nbtstat：根据ip查主机名
* netsh inter ipv4 add neighbors [if] [ip] [mac]：解决The ARP entry addition failed: Access is denied.
* robocopy
* cd. > 文件名：相当于用touch创建
* tasklist /svc
* chkntfs /x C: 取消对C盘的检查
* msinfo32
* restore
* wbadmin 备份工具
* rstrui

* * * * *

```
dism /online /cleanup-image
dism /cleanup-mountpoints
dism /online /cleanup-image /analyzecomponentstore
dism /online /cleanup-image /startcomponentcleanup /resetbase
```


* * * * *

cmd /U的效果描述是使向管道或文件的内部命令输出成为Unicode，实际上还必须改chcp才行，否则乱码

使用VBS实现按键盘的某个键：https://zhidao.baidu.com/question/97848681.html

防火墙关闭端口：netsh advfirewall firewall add rule name = "Disable port 135 - TCP" dir = in action = block protocol = TCP localport = 135

cacls
-----

```
cacls file /E /G Users:W // processed file:...
/E是修改，如果不加，会清除掉原来所有用户的权限，会问一句Are you sure (Y/N)?，可以用echo Y|自动确认，注意Y之后不能有空格
/G是追加；如果用/P，会消除掉某一个用户原来的权限
perm可以是：N无，R读取，W写入，C更改，F完全控制
```

注册表控制cmd窗口属性
---------------------

* https://zhidao.baidu.com/question/77162600.html

* * * * *

隐藏地启动程序。注意没有守护：

```
CreateObject("Wscript.Shell").run "bash ~/.boot.sh",vbhide

另一种方式：
wscript.exe "C:\yourpath\invis.vbs" "your_file.bat"
而invis.vbs：
CreateObject("Wscript.Shell").Run """" & WScript.Arguments(0) & """", 0, False
0表示隐藏cmd窗口，true表示等待cmd命令运行结束才返回
```

创建快捷方式：

* https://wenku.baidu.com/view/8ad6ebfac8d376eeaeaa31ef.html
* http://blog.pfan.cn/smallstar/34041.html

申请管理员权限
--------------

```
cd /d %~dp0
%1 start "" mshta vbscript:createobject("shell.application").shellexecute("""%~0""","::",,"runas",1)(window.close)&exit
```

未分类
------

if ERRORLEVEL 1：%errorlevel%**大于等于**1时执行之后的命令；not就是小于

返回值可以直接接`|| goto :error`跳到失败的处理部分

调用另一个bat，call会同步调用，start /b会异步调用，但是它们都会共享原来的窗口

start的第一个参数如果加引号，会被认为是titile。所以一般是start "" ...

```
set /p b=输入b的值；如果直接回车，变量不会创建，要用 "%varname%" == "" ...判断，引号不可省
if %a% == 1 (...) else (...) // 括号内可换行
echo (123) 输出(123)，if 1==1 (echo (123))会认为(123是要输出的内容而把内层的回括号与外层匹配上，而且单独一个回括号不会有任何报错
&&还是比||优先级高的
```

对话框
------

```
start mshta vbscript:msgbox("权限不足，无法执行！",0,"灾难性错误")(window.close)
```

查看端口占用：netstat -ano，会列出pid；不加参数会持续监测

tasklist /M：根据进程名搜索。但是居然无法根据PID搜索，只能直接用列出所有的然后grep

psping：直接用就是ICMP，加端口就是TCP；还有测延迟和带宽的模式，需要运行服务端的psping，但没看懂客户端的操作和TCP模式有什么不同。



HELP：
CALL           从另一个批处理程序调用这一个。
COLOR          设置默认控制台前景和背景颜色。
COMP           比较两个或两套文件的内容。
COMPACT        显示或更改 NTFS 分区上文件的压缩。
COPY           将至少一个文件复制到另一个位置。
DEL            删除至少一个文件。
DOSKEY         编辑命令行、撤回 Windows 命令并
               创建宏。
DRIVERQUERY    显示当前设备驱动程序状态和属性。
ERASE          删除一个或多个文件。
FC             比较两个文件或两个文件集并显示
               它们之间的不同。
FIND           在一个或多个文件中搜索一个文本字符串。
FINDSTR        在多个文件中搜索字符串。
FOR            为一组文件中的每个文件运行一个指定的命令。
FORMAT         格式化磁盘，以便用于 Windows。
FSUTIL         显示或配置文件系统属性。
FTYPE          显示或修改在文件扩展名关联中使用的文件
               类型。
GOTO           将 Windows 命令解释程序定向到批处理程序
               中某个带标签的行。
GPRESULT       显示计算机或用户的组策略信息。
GRAFTABL       使 Windows 在图形模式下显示扩展
               字符集。
ICACLS         显示、修改、备份或还原文件和
               目录的 ACL。
IF             在批处理程序中执行有条件的处理操作。
LABEL          创建、更改或删除磁盘的卷标。
MD             创建一个目录。
MKDIR          创建一个目录。
MKLINK         创建符号链接和硬链接
MODE           配置系统设备。
MORE           逐屏显示输出。
MOVE           将一个或多个文件从一个目录移动到另一个
               目录。
OPENFILES      显示远程用户为了文件共享而打开的文件。
PATH           为可执行文件显示或设置搜索路径。
PAUSE          暂停批处理文件的处理并显示消息。
POPD           还原通过 PUSHD 保存的当前目录的上一个
               值。
PUSHD          保存当前目录，然后对其进行更改。
RD             删除目录。
RECOVER        从损坏的或有缺陷的磁盘中恢复可读信息。
REN            重命名文件。
RENAME         重命名文件。
REPLACE        替换文件。
RMDIR          删除目录。
SETLOCAL       开始本地化批处理文件中的环境更改。
SCHTASKS       安排在一台计算机上运行命令和程序。
SHIFT          调整批处理文件中可替换参数的位置。
SHUTDOWN       允许通过本地或远程方式正确关闭计算机。
SORT           对输入排序。
START          启动单独的窗口以运行指定的程序或命令。
SUBST          将路径与驱动器号关联。
SYSTEMINFO     显示计算机的特定属性和配置。
TASKLIST       显示包括服务在内的所有当前运行的任务。
TASKKILL       中止或停止正在运行的进程或应用程序。
TITLE          设置 CMD.EXE 会话的窗口标题。
TREE           以图形方式显示驱动程序或路径的目录
               结构。
VERIFY         告诉 Windows 是否进行验证，以确保文件
               正确写入磁盘。
XCOPY          复制文件和目录树。

此项并不是系统代理设置，ie的代理设置才是系统代理设置
netsh winhttp import proxy source =ie
netsh winhttp reset proxy
netsh winhttp show proxy

net user 用户名 密码 /add
net localgroup administrators 用户名 /add

wpeutil：PE下可用，TODO:测试RE下是否可用
reboot、shutdown、InitializeNetwork

logoff
