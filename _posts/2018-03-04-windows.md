---
title: Windows使用笔记
---

## 重置UWP应用

```powershell
Get-AppXPackage -AllUsers -Name xxx | % {Add-AppxPackage -DisableDevelopmentMode -Register "$($_.InstallLocation)\AppXManifest.xml" -Verbose}
```

## 记事本保存日期

* 记事本第一行写入`.LOG`，每次保存的时候就会自动在最后一行写入时间和日期
* F5是手动添加

## 快捷键

* 显示右键菜单：Shift + F10
* 重启部分驱动：Win + Ctrl + Shift + B
* 打开属性：Alt+双击

## 手动卸载Office

* https://support.office.com/zh-cn/article/手动卸载-office-4e2904ea-25c8-4544-99ee-17696bb3027b?ui=zh-CN&rs=zh-CN&ad=CN

## DUMP和垃圾文件

* %windir%\System32\config\systemprofile\AppData\Local\CrashDumps（需要权限）
* %LocalAppData%\CrashDumps
* %windir%\LiveKernelReports
* %LocalAppData%\Microsoft\vscode-cpptools\ipch
* %LocalAppData%\SquirrelTemp
* %AppData%\baidu\BaiduNetdisk\AutoUpdate\Download

## 命令行拨号

* 自动重连：https://www.zhihu.com/question/59449991
* `%windir%\System32\rasdial.exe 宽带连接名字 账号 密码`

## 路径

* `D:123.txt`D盘的最后一次工作路径下的相对路径，如果没有则为根
* `\123.txt`表示当前盘根目录下的123.txt，属于绝对路径
* `\\PCName\123.txt`是UNC路径，表示局域网上的文件，其中PCName是计算机名，也可以是ip，123.txt是共享的文件名；用C$来表示共享的根目录
* `\\?\C:\123.txt`、​`\\?\UNC\PCName\123.txt`或者用点：设备路径，后面跟的是设备名；支持非常长的路径和单纯以点结尾的文件；不能用斜杠，只能是绝对路径，因为它不会规范化
* `C:\directory\..\directory\file.txt`：.net算完全限定路径，但是带有相对路径符号，实际程序可能认为是无效路径​

## 创建服务

* 正常的服务不能创建新的程序，只能创建别的服务。也许你需要的是计划任务
* sc.exe create 服务名 binPath= "路径" start= auto/delayed-auto：只能用于本来就是服务(实现了ServiceMain)，等号后必须有空格和引号，auto为不登录就运行；对应的PS是：New-Service -Name "xxx" -BinaryPathName "xxx"。但又好像bat也行，也有人说要用cmd /c
* NSSM:https://www.nssm.cc/ 有GUI但是好像不能脱离它运行；上次更新是2017年
* https://github.com/winsw/winsw C#写的，活着
* https://github.com/rozanski/srvstart 很老的程序，最初是给NT4写的

```powershell
$params = @{
    Name = "Nginx"
    BinaryPathName = "C:\Nginx\nginx.exe"
    DisplayName = "Nginx"
    StartupType = "Automatic"
    Description = "Nginx"
}
New-Service @params
```

## 计划任务

* 如果是执行bat，有的说必需指定`Start in (optional)`，或者用cmd /c start "" ...。还有人说Start字段一定不能有引号，Start in也不可以，`program > program/script`可以有；反正依赖工作路径的一定要指定`Start in`否则会失败
* 如果是登陆时执行的，好像必须要delay，否则很可能失败。而且实际上未输密码时的某个时候就已经开始计时了
* 图形界面可以右键运行，当时就能测试一下
* Hidden好像没用，如果要隐藏运行，选用另一个用户的身份执行，且要选不管那个用户是否登录；SYSTEM两者都满足
* 关闭断开电源时杀掉程序
* 一些图形界面可能出错的原因：https://serverfault.com/questions/734035/running-a-batch-file-from-task-scheduler-without-user-being-logged-in
* 实际会放到`C:\Windows\System32\Tasks`中，以xml的形式存在
* 日志默认关闭，可用`REG ADD "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\WINEVT\Channels\Microsoft-Windows-TaskScheduler/Operational" /v Enabled /t REG_DWORD /d 1 /f`开启

### 命令

* at已经废弃了，现在应使用Schtasks：https://docs.microsoft.com/zh-cn/windows/win32/taskschd/schtasks
* schtasks /Run、/Create、/Delete /TN xxx
* schtasks /Create /TN "KillQQProtect.exe" /TR "taskkill /f /t /im qqprotect.exe" /SC ONLOGON /RL HIGHEST /DELAY 30 /F
* /SC控制时间，可与其它参数组合，如： /SC DAILY /ST 11:00
* /RU指定要执行命令的用户
* 如果希望弹出界面，必须用/IT

## OneDrive

调整上传的线程数：`%localappdata%\Microsoft\OneDrive\settings\PersonalGlobal.ini`，在开头加入`numberOfConcurrentUploads=3`。最小值为1（默认），最大值为3，根据实际需要选择即可。

## 修改ssh的默认shell

```powershell
New-ItemProperty -Path "HKLM:\SOFTWARE\OpenSSH" -Name DefaultShell -Value "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -PropertyType String -Force
```

## MouseKey

* 按组合键：左alt+左shift+Num Lock，右下角任务栏就出现了一个鼠标图标
* 按Num Lock，鼠标图标就会在有红X和无红X间变换
* 无红X的状态下 小键盘5键就相当于鼠标左键

## 禁用预留储存

* DISM.exe /Online /Get-ReservedStorageState
* DISM.exe /Online /Set-ReservedStorageState /State:Disabled

## UEFI的bootmgr无法引导GRUB？

* https://www.zhihu.com/question/373839882/answer/1033406276

## WSL

* 无法使用systemctl，可使用`systemctl.py`替代部分功能：`mv /usr/bin/systemctl /usr/bin/systemctl.old && curl https://raw.githubusercontent.com/gdraheim/docker-systemctl-replacement/master/files/docker/systemctl.py > /usr/bin/systemctl && chmod +x /usr/bin/systemctl`；或用service。WSL2可用：https://github.com/arkane-systems/genie
* 开启dbus可以多启用一些功能：sudo service dbus start
* 使用`wsl+Linux命令`执行命令，不会解析.bashrc
* dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /norestart，之后必须重启
* 根目录的网络位置：\\wsl$\Debian

## 启用PATH的超长路径支持（单个大于260字符）

```powershell
Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem' -Name LongPathsEnabled -Type DWord -Value 1
```

但还需要每个应用声明自己支持超长路径（manifest）：

```xml
<application xmlns="urn:schemas-microsoft-com:asm.v3">
    <windowsSettings xmlns:ws2="http://schemas.microsoft.com/SMI/2016/WindowsSettings">
        <ws2:longPathAware>true</ws2:longPathAware>
    </windowsSettings>
</application>

```

## NV提供的图像放大程序

需要安装好Geforce Experience，默认会加到PATH里。第一个数字是放大倍数；第二个数字是模式，1为monochromatic，2为full color，在非RTX卡上用1快得多。输出为去掉后缀的文件，需手动加后缀。在我这里测试，模式1时输出是黑白的，模式2会失败，生成4KB大小的全黑文件

```
C:\Program Files\NVIDIA Corporation\NVIDIA NvDLISR\nvdlisrwrapper.exe D:\testimage.png 4 2
```

## Windows Terminal(wt)

* 定义了`WT_SESSION`环境变量
* VSC的终端：`TERM_PROGRAM`为vscode

```json
"defaults": {
    "useAcrylic": true,
    "acrylicOpacity": 0.8,
    "fontFace": "Cascadia Mono PL",
    "startingDirectory": "." // 必须加这个，在地址栏里打wt时才会切换到当前目录
},
```

## 禁用自动更新

```reg
[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\au]
"NoAutoUpdate"=dword:00000001
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings]
"FlightSettingsMaxPauseDays"=dword:00000020  # 暂停更新0x20天
```

## CVE获得System权限

* https://github.com/WindowsExploits/Exploits/tree/master/CVE-2017-0213
* https://github.com/klinix5/CVE-2021-1727

## diskpart

* ESC清除当前输入，help xxx显示帮助
* 挂载UEFI分区：`mountvol z: /s`

```cmd
list vol # 一般情况下使用
list disk; select disk 0; list partition; select partition 0
assign/remove letter Z
format RECOMMENDED QUICK
```

## bcdedit

* BCD文件位置：\EFI\Microsoft\Boot\BCD
* 注意使用PS时大括号外要加引号
* 不带任何参数相当于/enum ACTIVE，只会显示bootmgr及其displayorder中的项。指定FIRMWARE可看到固件顺序，指定
* bcdedit /sysstore C: 临时指定存放BCD文件的盘
* bcdedit /set recoveryenabled No 默认会使用`{current}`
* 调整启动顺序，无需指定`{bootmgr}`：bcdedit /displayorder {1} {2}，可指定/addfirst,/addlast,/remove，都不指定就是覆盖；bootsequence只指定下一次的
* https://docs.microsoft.com/zh-cn/windows-hardware/drivers/devtest/bcd-boot-options-reference

## Hosts

* 要用UTF8 with BOM，否则行尾注释有中文的时候有几率导致那一行失效
* 理论上先出现的覆盖后出现的，实际如果一行有多个，第一个可能不会成功覆盖
* 每一行只有前10项（第一项为IP）有效：127.0.0.1 a b c d e f g h i j中的j就是无效的

## 终端

* https://github.com/cmderdev/cmder C++，完整版带有Git for Windows，好像内部集成了ConEmu
* https://github.com/Eugeny/tabby TS，之前叫Terminus
* https://github.com/Maximus5/ConEmu C++
* https://github.com/cbucher/console ConsoleZ，C++，社区较差
* https://github.com/felixse/FluentTerminal UWP

## ReFS

* refsutil leak D: /a /x
* fsutil fsinfo refsinfo D:
* 大版本升级后会自动更新，导致以前的系统无法识别
* 启动：需Build 20185+，无法直接安装过不去OOBE，UWP无法使用因为默认开启EFS而ReFS不支持

## WinRE

* 没有powershell

## Windows ADK

* 安装到本机可以自由选组件，安装到指定目录则要全下

## 7z

* https://sourceforge.net/projects/sevenzip/files/7-Zip/ 其中extra为精简版的7za，差不多只支持7z xz zip gz tar；https://www.7-zip.org/a/7zr.exe 更精简，只支持7z，不支持加密
* 压缩：7z a -r 压缩包名 文件名。其中文件夹用dir则会添加本身，用"dir/*"则添加其内容，其中*由7z自己处理，不由shell展开
* 解压：7z x 压缩报名 -o 目标文件夹。不加-o则解压到CWD
* 其他命令：l列出所有内容，t测试是否出错，d删除压缩包内的文件，u更新文件，e不保留指定前缀解压
* -p：指定密码
* -ao[a/s/u]：释放时遇到同名文件如何处理，a覆盖，s跳过，u自动重命名被释放的文件
* -ax!*.7z：排除文件
* -slp：申请大内存页，加快压缩速度，但刚开始时会停一下，需要管理员模式，推荐内存3GB+，压缩大量内容时启用
* -si：从stdin读取，-so：输出到stdout
* -sfx7z.sfx：图形化自解压
* -mcu：对于zip，使用U8储存文件名；解压其他CP压缩包时用-mcp=xxx指定
* 算法：zip默认用的Deflate，-mm=copy不压缩，-mm=ppmd对于文本内容较好；7z默认用的LZMA2，且支持多线程，-mx=9极限压缩

## Windows API

* CommandLineToArgvW：把一行命令（一个U16字符串）解析成argv和argc

## 其他

* 计算机名最好在15位以内
* 修改所有者为NT SERVICE\TrustedInstaller，直接搜后者找不到
* `~`并不支持，要用`%userprofile%`
* 另一种最高权限工具：https://www.sordum.org/9416/powerrun-v1-4-run-with-highest-privileges/
* %COMSPEC%为默认的shell，但最好不要改因为大家都默认是CMD
* System32/main.cpl是鼠标设置，但是~~直接打main也能弹出来，真的反人类~~不明白为什么有的不会
* `a.txt`与`a.txt...`等视为同一文件
* wusa命令行：卸载更新用/uninstall /kb:编号
* 解压zip：expand-archive
* 挂载ISO：mount-diskimage
* 从小娜处执行命令：只会执行那个程序而不会把参数传递过去
* fsutil behavior set memoryusage 2：增大NTFS缓冲级别
* shell:startup shell:sendto
* winfr：微软出的数据恢复软件，傲梅有界面，需2004
