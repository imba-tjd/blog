---
title: NGINX
---

* 主要用于Http服务器，反向代理服务器，邮件服务器，负载均衡
* 采用epoll模型，异步非阻塞，无惊群现象
* 一个master，解析配置和控制多个worker，每个worker是单线程

## 安装、运行

* 安装最新版本（apt中的不算太新）：`(sudo su) curl https://nginx.org/keys/nginx_signing.key | apt-key add -; echo deb https://nginx.org/packages/mainline/debian/ buster nginx > /etc/apt/sources.list; apt remove nginx-common; apt update; apt install nginx`
* 默认目录结构，apt装的是分散的。配置文件：/etc/nginx；网站根目录：/var/www/html；主程序：/usr/sbin/nginx(/sbin/nginx)；日志：/var/log/nginx；so模块：/usr/lib/nginx/modules(/usr/share/nginx/modules)；系统证书：/etc/ssl/certs和private
* nginx -s stop(强行退出)、quit(正常退出)、reload(重载配置文件)、reopen(重新打开日志文件)
* 绑定端口，可用authbiind或用iptables转发或用docker；好像www-data用户组可以绑定80端口？不确定

## [变量](http://nginx.org/en/docs/varindex.html)

* 大全：https://www.tuicool.com/articles/UZf222
* $arg_abc：url中?abc=xxx的值；$args：所有url参数
* $geo：客户端的IP？
* $uri：去掉参数、合并连续斜杠、decode url；$request_uri没有这些操作，直接是请求内容
* $http_host永远等于请求头中的HTTP_HOST
* $host equals $http_host, lowercase and without the port number (if present), except when HTTP_HOST is absent or is an empty value. In that case, $host equals the value of the server_name directive of the server which processed the request. $host is specifically the first server_name that is defined in the current server block. if you have multiple server_names, only the first one will appear.
* $server_name：server_name指令捕获到的？
* $proxy_host：proxy指令中，默认会把Host设为当前服务器的地址，此为upstream的ip
* set $www_root $1; # 声明变量，但直接在匹配时用命名分组`(?<domain>…)`更好
* https://www.jianshu.com/p/0850db5af284

## nginx.conf概要

* 以下参数如果为默认值，使用【默】标识，如果没写就不是默认值
* 内存页(memory page)可用getconf PAGESIZE查看，Debian是4k；以下用2MP表示两个内存页
* Linux下的相对路径是相对于/etc/nginx的路径；但wwwroot默认是/usr/share/nginx/html，一般手动指定成/var/www/html
* Windows下所有的相对路径都是相对于exe的路径；路径用反斜杠有可能出现有时可以用有时不行的情况，因为会发生转义，所以直接用斜杠吧

## [main、events](https://nginx.org/en/docs/ngx_core_module.html)

```conf
#load_module modules/ngx_stream_module.so
include modules-enabled/*.conf; # 该文件夹下有50-mod-stream.conf等文件，是/usr/share/nginx/modules-available下的的软链接，里面只有一行上一行

user www-data # 默认是nobody

#worker_processes auto; # 默认是1，auto则为虚拟cpu的数量；不过StackExchange上推荐1就够用作WebServer了，如果是负载均衡，1个用于HTTP，其余的每个核一个用于HTTPS
#worker_cpu_affinity # 在高并发情况下，通过设置cpu粘性来降低由于多CPU核切换造成的寄存器等现场重建带来的性能损耗
#pid /var/run/nginx.pid; # 仅用于记录每次启动的pid是什么，不是指定pid
pcre_jit on; # 默认off，不过好像编译时能改变默认值

#error_log # 见《日志》部分

events { # 此指令必须要有，即使内容为空也要有
    #use epoll; # 默认使用最适合操作系统的那个
    #worker_connections 768; #【默】每一个worker的最大连接数，总的要乘以worker_processes，决定能连接客户端的数量，但用作反代时数量要除以4，普通除以2；不能超过main.worker_rlimit_nofile（默认没有限制但操作系统限制最大65535）；不足时会说too many open files
    #accept_mutex # 现在的版本已经不需要这个参数了
    multi_accept on; # 收到一个新连接通知后接受尽可能多的连接
}
```

## [http、server](https://nginx.org/en/docs/http/ngx_http_core_module.html)

```conf
http {
    include mime.types; # 文件扩展名与文件类型映射表
    default_type application/octet-stream; # 默认文件类型，nginx的默认为text/plain，这个是apt的默认值
    #types_hash_max_size 2048; # 默认值1024
    #server_tokens off # 出错页面隐藏版本号
    #server_names_hash_bucket_size 64; #【默】建议设为域名长度的两倍；server_names_hash_max_size默认512，当虚拟主机变多时需要增大
    #server_name_in_redirect off; #【默】

    sendfile on; # 开启高效文件传输模式；用来进行下载等IO重负载时应设为off，或使用aio和directio
    tcp_nopush on; # 上一条开启时才有效，在一个数据包里发送所有头文件，而不一个接一个的发送
    #tcp_nodelay on; #【默】当需要及时发送数据时，就应为on
    #keepalive_timeout 75; # 【默】http1.1长连接超时时间，与TCP的keepalive意义不同，见：http://blog.sina.com.cn/s/blog_e59371cc0102ux5w.html
    #keepalive_requests 100; #【默】单连接请求上限次数
    #client_max_body_size 10m; # 允许客户端请求的最大单文件字节数，默认1m，如要上传大文件需修改它
    #client_body_buffer_size 8k; # 默认2MP

    # 虚拟主机，其实最好使用以下两行这种组织方式
    # include conf.d/*.conf;
    # include sites-enabled/*; # 里面的内容是sites-available的软链接
    server {
        # 一些listen的socket参数只需也只能设置一次，包括下面这俩和fastopen=3；而已知ipv6only必须重启nginx才能生效，reload无效，不知其它是否也是这样
        listen [::]:80 reuseport ipv6only=off; # 地址可指定ip，可含*，一次只能指定一条；支持非https的http2
        server_name  localhost; # 根据Host字段匹配；具体见下一小点

        #charset gb2312; # 默认字符集

        client_header_buffer_size 32k;
        large_client_header_buffers 4 32k;
        client_max_body_size 8m; # 允许客户端请求的最大单文件字节数
        client_body_buffer_size 128k # 缓冲区代理缓冲用户端请求的最大字节数
        #send_timeout client_header_timeout client_body_timeout reset_timeout_connection
        sendfile_max_chunk 100k;  #每个进程每次调用传输数量不能大于设定的值，默认为0，即不设上限。

        #access_log  logs/host.access.log  main;
        error_page  404              /404.html;
        error_page  500 502 503 504  /50x.html;

        root /var/www/html;
        index index.html;
    }

    server {
        listen 80 default_server; # 单独放在一个server指令中
        return 444; # 是非标准的错误代码
    }
}
```

### server_name

* 用于配置基于名称的虚拟主机，如果server只有一项则直接不会进行匹配
* 优先最长匹配完整的且速度快，其次匹配星号在开头的，再次星号在结尾的，再次正则（以~开头，点需要转义）；其中正则一旦匹配到就选中，不进行最长匹配；www.*.example.com是无效的
* 匹配不到时使用listen中的default_server，不同端口能有不同的，V4和V6也可不同；如果不存在default_server就选第一个listen到的
* .example.com会同时匹配*.example.com和example.com，但不属于完整匹配速度不快
* *.example.com不会匹配到example.com，但会匹配到www.sub.example.com，然而后者若用 *.example.com 的证书是无法验证通过的，Wildcard证书只对一个级别的子域有效
* 该指令不存在时与server_name ""相同，可匹配Host字段不存在的情形
* 不要使用*或者_，这个和随便乱输一样，就是用作匹配不到的。该指令不存在“匹配所有”的功能

### server.location

```conf
location = / {
    # 完全匹配 =；大小写敏感 ~；忽略大小写 ~*
}
location ^~ /images/ {
    # 前半部分匹配 ^~，非正则
    # 也可以使用正则，如：location ~* \.(gif|jpg|png)$ { }
}

location / { # 此处的斜杠指的是url中顶级域名之后的部分且不包括参数(?)；最长匹配原则，最后才匹配/
    #add_header content-type “text/html”; # 让没有后缀的文件识别为html
    try_files $uri $uri/ =404; # 先尝试将请求视为文件，然后是目录，然后回落到404

    allow 192.168.10.100;
    allow 172.29.73.0/24;
    deny all;
}

location /NginxStatus {
    stub_status           on;
    access_log            on;
    auth_basic            "NginxStatus";
    auth_basic_user_file  conf/htpasswd;
}

location /images/ { # 访问其它路径
    root /data; # 把另一个路径作为基路径，注意此时至少访问的真实路径为/data/images/
}

location ~ \.(gif|jpg|png)$ {
    root /data/images/$1; #可直接用正则捕获到的分组结果
    expires 10d;
}

# alias
location /blog {
    alias /home/barret/www/blog/;
}
location ~ ^/blog/(\d+)/([\w-]+)$ {
    # /blog/20141202/article-name
    # -> /blog/20141202-article-name.md
    alias /home/barret/www/blog/$1-$2.md;
}
```

### [TLS](https://nginx.org/en/docs/http/ngx_http_ssl_module.html)

* 本来ssl建立在http请求发送之前，无法把两个不同的站点指向同一个ip（即listen必须用不同的ip）；但是现在版本支持sni，使用nginx -V可查看是否支持
* 默认就使用http2？listen443隐式含有ssl？
* 可使用openssl ciphers查看所有可用的加密套件，加-s -tls1_3可只看TLS1.3的
* 防止SNI不匹配时Subject Alternate Name泄露，使浏览器报ERR_SSL_VERSION_OR_CIPHER_MISMATCH：https://github.com/QVQNetwork/ssl-patch/blob/master/nginx-config-nosni/README-zh_cn.md
* 现在我这里ssl_ciphers指定TLS1.3的加密套件会失败，说no cipher match，但不加此指令仍可正常使用1.3
* 证书有时需用证书链，可在 https://www.myssl.cn/tools/downloadchain.html 查找下载，使用`cat example.com.crt bundle.crt > example.com.chained.crt`连接，顺序不对会失败

```conf
http {
    ssl_protocols TLSv1.3 TLSv1.2; # 如果只开1.3，则无需指定ssl_ciphers
    #ssl_prefer_server_ciphers on; # 因为下一项限制了可用的加密套件，关闭此项可以使无AES加速的设备选择自己想要的，也不会有安全问题
    ssl_ciphers TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-CHACHA20-POLY1305;
    ssl_session_timeout 1d; # 默认是5m
    ssl_session_cache shared:SSL:10m; # 避免二次握手的时间；SSL是个名字，1兆可储存约4000会话；好像不要使用builtin类型，不好；默认是none
    #ssl_session_tickets off; # 会话复用，默认是on，使用服务器集群且不希望部署共享票证密钥时可设为off
    ssl_buffer_size 4k; # 调小有利于减少首字节时间；默认16k，传大文件如图片则无需更改
    ssl_dhparam certs/dhparam.pem; # 生成（耗时约1分钟）：openssl dhparam -out /etc/nginx/certs/dhparam.pem 2048
    #ssl_ecdh_curve # 默认为auto，不知boringssl可否设为CECPQ2
    ssl_early_data on; # 开启0-RTT？

    # OCSP stapling；客户端会验证服务器证书的有效性，此指令允许服务器发送缓存的OCSP记录；必须要保证resolver可用
    ssl_stapling on;
    ssl_stapling_verify on;
    #ssl_trusted_certificate ssl_client_certificate # verify chain of trust of OCSP response using Root CA and Intermediate certs
}

http.server {
    listen [::]:443 ssl http2 reuseport ipv6only=off;
    server_name  www.simplehttps.com;

    # 也可以放在http指令中
    ssl_certificate      certs/fullchain.pem; # 或.crt
    ssl_certificate_key  private/privkey.pem; # 或.key

    add_header Strict-Transport-Security "max-age=15768000" always; # 半年（182天多）HSTS

    # location 略
}
http.server {
    listen [::]:80;
    server_name  www.simplehttps.com;
    #add_header HSTS略
    return 301 https://$host$request_uri;
}
http.server { # 禁止ip和SNI不匹配的访问；也必须有证书指令否则会报emerg错误拒绝启动；需小心SNA泄露，可用自签证书
    listen [::]:80 default server;
    listen [::]:443 ssl default_server;
    #ssl_protocols SSLv3; # 本来想通过这个产生SSL错误的，但是设了以后会导致所有server都出错
    return 403;
}
```

## [日志](https://nginx.org/en/docs/http/ngx_http_log_module.html)

* 把日志文件mv走后不会自动重新生成新的日志文件，因为一般linux文件被打开情况下移走，原来操作这个文件的进程还是有这个文件的inode等信息，原进程还是读写原来的文件，所以简单的mv是无法生效的。此时要用`nginx -s reopen`
* 使用log_format指令自定义（access_log？）日志内容；默认为combined，还支持main
* access_log不能写在main中，最高级别是http；可以使用gzip参数压缩
* error_log可以写在main中，日志级别可以是debug, info, notice, warn, error, crit, alert, or emerg，文件可以是stderr
* 可以使用多个error_log指令，指定不同文件放不同级别的日志
* 设为off关闭日志

```conf
http{
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
}
```

## [Proxy](https://nginx.org/en/docs/http/ngx_http_proxy_module.html)

### 正向代理

* 正向代理（Forward Proxy）不要出现server_name；必须有resolver，否则报502 Bad GateWay？
* 正向代理的$url是不包含真正请求的网址的，直接浏览器访问正向代理会报502；真正网址的在Host字段中，浏览器显示的也是真正的网址
* nginx的正向代理不支持https，因为不支持connect方式，用https://github.com/chobits/ngx_http_proxy_connect_module 可以但需自己编译一遍
* curl不支持用https连接正向代理
* 关键是如果用http访问正向代理并不会加密成https

```conf
location / {
    proxy_pass $scheme://$host$request_uri;

    #proxy_redirect off;
    proxy_set_header Host $http_host; # 解决如果URL中带"."后Nginx 503错误，默认是$proxy_host？
    proxy_set_header X-Real-IP $remote_addr; # 正代没有规定，可能为最开始的ip；反代为直接接收到的ip
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # 会记录每一跳的信息，由逗号和空格分隔
    proxy_set_header User-Agent $http_user_agent;
}

location /proxy {
    proxy_pass
}
```

### proxy其它设置

```conf
#proxy_connect_timeout、proxy_read_timeout、proxy_send_timeout 60; #【默】跟后端服务器连接、接收、发送的超时时间

proxy_buffer_size 4k # 用户头信息的缓冲区大小，默认2MP
proxy_buffers 8 32k; # 第二个参数应大于网页平均大小，默认1MP
proxy_busy_buffers_size 64k # 高负荷下缓冲大小
proxy_max_temp_file_size 0 # 当proxy_buffers放不下后端服务器的响应内容时，会将一部分保存到硬盘的临时文件中，这个值用来设置最大临时文件大小，默认1024M，与proxy_cache没有关系。大于这个值，将从upstream服务器传回。设置为0禁用
proxy_temp_file_write_size 64k # 当缓存被代理的服务器响应到临时文件时，这个选项限制每次写临时文件的大小。proxy_temp_path（可以在编译的时候）指定写到哪那个目录
proxy_next_upstream error timeout invalid_header http_502;

# 配置代理服务器HTTP状态缓存时间
proxy_cache_valid 200 302 10m;
proxy_cache_valid 301 1h;
proxy_cache_valid any 1m;
```

### [反向代理](https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/)、[负载均衡](https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/)

* TCP和UDP负载均衡教程：https://docs.nginx.com/nginx/admin-guide/load-balancer/tcp-udp-load-balancer/
* upstream文档：https://nginx.org/en/docs/http/ngx_http_upstream_module.html
* upstream中的keepalive指令不是和upstream的长连接，见[此博客](https://lanjingling.github.io/2016/06/11/nginx-https-keepalived-youhua/#二、nginx长连接——keepalive)

```conf
upstream big_server_com { # 这里面的server指令并不是普通的server，因为context是upstream
    # 负载策略指令：least_conn、ip_hash，用了别的就不能用weight了
    server 127.0.0.3:8000 weight=5;
    server 127.0.0.3:8001 fail_timeout=10;
    server 192.168.0.1:8000 max_fails=3; # 设为0为无限
    server 192.168.0.1:8001 backup; # 当primary不可用时使用；设为down可以阻止新连接
}

server {
    listen          80;
    server_name     big.server.com;
    access_log      logs/big.server.access.log main;
    proxy_http_version 1.1; # 默认1.0，可能有性能损失

location /proxy {
    proxy_pass      http://big_server_com; # 最后如果加反斜杠，效果是会把原来的/proxy部分去掉后再拼接过去
    proxy_ssl_server_name   on; # 反代时默认无sni，这两条可以开启并自定义
    proxy_ssl_name  “api.cloudflare.com”;
    proxy_set_header cookie $http_cookie;
    proxy_ssl_verify on # on时需确保服务器内有对方的证书，默认为off
}
```

## [gzip](https://nginx.org/en/docs/http/ngx_http_gzip_module.html)

* 可以在http、server、location中
* 好像https开gzip会有安全问题，You should disable gzip for SSL traffic：https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=773332 https://serverfault.com/questions/544279/nginx-disable-gzip-compression-for-https-only https://github.com/h5bp/server-configs-nginx/issues/72

```conf
gzip on;
gzip_min_length 1k; # 小于1k可能会越压越大，默认是20，大小看的是Content-Length的值
#gzip_buffers 32 4k; #【默】缓存的数量和大小，第二个参数应和一个内存页大小相同
gzip_comp_level 6; # 默认是1
gzip_types text/plain text/css application/json application/javascript text/javascript; # 匹配mime类型进行压缩，text/html总会被压缩
gzip_proxied any # Nginx作为反向代理的时候启用，决定开启或者关闭后端服务器返回的结果是否压缩，匹配的前提是后端服务器必须要返回包含”Via”的header
gzip_vary on; # 会在响应头加个Vary: Accept-Encoding，可以让前端的缓存服务器缓存经过gzip压缩的页面
gzip_disable "msie6";
gzip_static on; # 在压缩之前查找是否有预先gzip处理过的资源，就不用临时压缩了
```

### [Brotli](https://github.com/google/ngx_brotli)

* 压缩等级1级时压缩率就比gzip9级高，而且耗时还低
* 不自带，要自己编译nginx
* ngx_brotli_filter用于压缩响应，ngx_brotli_static用于预压缩的文件

```conf
brotli            on;
brotli_comp_level    6;
brotli_min_length    1k;
brotli_types    text/plain text/css text/xml text/javascript text/x-component application/json application/javascript application/x-javascript application/xml application/xhtml+xml application/rss+xml application/atom+xml application/x-font-ttf application/vnd.ms-fontobject image/svg+xml image/x-icon font/opentype;
```

## 列出目录 server.autoindex

```conf
location /images {
    root   /var/www/nginx-default/images;
    autoindex on;
    autoindex_exact_size off; # 默认为on，显示bytes精确大小，off为MB等
    autoindex_localtime on; # 默认off，为GMT时间，改为on后是服务器时间
}
```

## Rewrite

```conf
if ($host = domain.com){
    rewrite ^ http://www.domain.com permanent;
}

if (!-e $request_filename){ # 访问时隐藏html后缀也能成功
    rewrite ^(.*)$ /$1.html last;
    break;
}

listen 80;
rewrite ^(.*) https://$host$1 permanent; # 80转https，但上面的return 301更好
```

## FastCGI和PHP

```conf
location ~ \.php$ {
    include snippets/fastcgi-php.conf;
    fastcgi_pass unix:/run/php/php7.3-fpm.sock; # With php-fpm (or other unix sockets)
    fastcgi_pass 127.0.0.1:9000; # With php-cgi (or other tcp sockets)
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include       fastcgi_params;
}
# deny access to .htaccess files, if Apache's document root concurs with nginx's one
location ~ /\.ht {
    deny all;
}
```

## 杂项指令

```
# resolver
# 根据文档，应该会默认使用系统的DNS
resolver 8.8.4.4 8.8.8.8 valid=300s;
resolver_timeout 10s;

# aio
# apt装的不支持此指令；用于传输大文件时启用
# http://www.cnblogs.com/wajika/p/6565913.html
aio threads;
```

## module

* 默认编译的模块：https://github.com/nginx/nginx/blob/master/auto/options 中所有以`--without`开头的

### APT装好后自带的

```
ngx_http_auth_pam_module.so
ngx_http_dav_ext_module
ngx_http_echo_module.so
ngx_http_geoip_module.so
ngx_http_image_filter_module.so
ngx_http_subs_filter_module.so
ngx_http_upstream_fair_module.so
ngx_http_xslt_filter_module.so
ngx_mail_module.so
ngx_stream_module.so
```

## 其它

* Nginx引入线程池是为了解决因为某些长时间阻塞的调用导致性能下降的问题，比如cache服务器服务大文件，还有一些大量计算的应用也可以尝试用它来解决，不过实际效果一般

## 其他人的配置

* https://github.com/h5bp/server-configs-nginx
* https://github.com/cloudflare/sslconfig/blob/master/conf
* https://ssl-config.mozilla.org
* https://github.com/denji/nginx-tuning

## 参考

* https://nginx.org/ https://www.nginx.com
* https://zhuanlan.zhihu.com/p/33418520
* https://zhuanlan.zhihu.com/p/24524057
* https://zhuanlan.zhihu.com/p/51653788
* https://blog.csdn.net/xifeijian/article/details/20956605

## TODO

https://github.com/taobao/nginx-book
https://github.com/jwilder/nginx-proxy
https://docshome.gitbooks.io/nginx-docs/content/
https://github.com/jinhailang/blog/issues/24
https://blog.ziki.cn/post/nginx-br-http2/
https://segmentfault.com/a/1190000009383543
https://segmentfault.com/a/1190000002924458
使用clang编译：https://community.centminmod.com/threads/guide-to-gcc-clang-compiler-selection-for-nginx-installs.13729/
* 中文文档（不新）：http://tengine.taobao.org/nginx_docs/cn/docs
* 未完全吸收的配置：https://zhuanlan.zhihu.com/p/24524057
* Nginx开发从入门到精通（未读）：http://tengine.taobao.org/book/
* 未读：Nginx 防止 SQL 注入、XSS 攻击的实践配置方法：https://blog.oioweb.cn/index.php/archives/1081.html
* 未读：手把手教你拿SSL Lab A+：http://wuy6.cn/index.php/example/137/
* https://einverne.github.io/post/2017/10/nginx-conf.html
* https://www.nginx.com/resources/wiki/start/topics/depth/ifisevil/
* http://blog.sina.com.cn/s/articlelist_1834459124_0_1.html
* https://blog.csdn.net/xxcupid/article/category/6411308
* https://www.kancloud.cn/kancloud/master-nginx-develop/51800
* https://www.nginx.com/blog/http-keepalives-and-web-performance/
* https://github.com/QVQNetwork/ssl-patch/blob/master/nginx-config-nosni/README-zh_cn.md Nginx 防止SSL嗅探

### 内容缓存 content caching

* https://docs.nginx.com/nginx/admin-guide/content-cache/content-caching/
* http://www.iigrowing.cn/web_nei_rong_huan_cun_nginx_gao_xing_neng_huan_cun_xiang_jie.html

nginx 的 combo 请求合并功能
